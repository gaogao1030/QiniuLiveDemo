var app_id,bindEvent,clear_members,client_id,close_connect,connect,elements,encodeHTML,formatTime,getLog,get_conversation,get_member,get_online_members,main,member_name,msgTime,newRoom,pressEnter,roomname,secret_key,sendMsg,showLog,showMsg,start,timeoutPromise;app_id=void 0,secret_key=void 0,msgTime=void 0,roomname="qiniuLiveDemo",member_name=void 0,newRoom=void 0,client_id="游客",this.chat_demo={},elements={},start=function(e,n){return elements={body:$("body"),printWall:$("#printWall"),sendMsgBtn:$("#btnSend"),inputSend:$("#chatInput"),inputNickName:$("#inputNickName"),confirmName:$("#confirmName"),changeName:$("#changeName")},AV.initialize(e,n),roomname="qiniuLiveDemo",app_id=e,n=n,get_conversation().then(function(e){return main(roomname,e,client_id)},function(e){return console.log("Error: "+error.code+" "+error.message)})},connect=function(e,n,t){var r,o;return o=AV.realtime({appId:app_id,clientId:e+":"+t,secure:!1}),r=new AV.Promise,o.on("open",function(){return o.room(n,function(e){return r.resolve(o,e)})}),r},close_connect=function(e){var n;return n=new AV.Promise,e.close(),e.on("close",function(){return n.resolve()}),n},get_conversation=function(){var e,n,t;return n=new AV.Promise,e=AV.Object.extend("_conversation"),t=new AV.Query(e),t.equalTo("attr.room_id",roomname),t.find({success:function(e){var t,r;return t=(null!=(r=e[0])?r.id:void 0)||"null",n.resolve(t)},error:function(e){return n.reject(e)}}),n},bindEvent=function(e,n){return elements.body.on("keydown",function(e){return pressEnter(e,n)}),elements.sendMsgBtn.on("click",function(){return sendMsg()}),elements.inputSend.on("click",function(){return"游客"===client_id?elements.changeName.modal("show"):void 0}),elements.confirmName.on("click",function(){var e;return client_id=elements.inputNickName.val(),e=elements.printWall,String(client_id).replace(/^\s+/,"").replace(/\s+$/,"")?get_conversation().then(function(n){return connect(roomname,n,client_id).then(function(n,t){return newRoom=t,t.join(function(){return e.scrollTop(e[0].scrollHeight),"游客"!==client_id&&showLog("你已经可以发送消息了。"),elements.changeName.modal("hide")})})},function(e){return console.log("Error: "+error.code+" "+error.message)}):alert("昵称不能为空")})},showLog=function(e,n,t){var r,o;return o=elements.printWall,o.scrollTop(o[0].scrollHeight),n&&(e=e+'<span class="strong">'+encodeHTML(JSON.stringify(n))+"</span>"),r=document.createElement("p"),r.innerHTML=e,t?$(r).insertBefore(o.children()[0]):o.append(r)},pressEnter=function(e,n){return 13===e.keyCode?sendMsg():void 0},encodeHTML=function(e){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")},sendMsg=function(){var e,n,t;return e=elements.inputSend,t=elements.printWall,n=e.val(),String(n).replace(/^\s+/,"").replace(/\s+$/,"")?"游客"===client_id?void alert("你当前的身份是游客不能发言"):newRoom.send({text:n},{type:"text"},function(r){return e.val(""),showLog(formatTime(r.t)+" 我：",n),t.scrollTop(t[0].scrollHeight)}):void alert("请输入点文字！")},getLog=function(e){var n,t,r,o;return o=new AV.Promise,elements=elements,r=elements.printWall[0],n=r.scrollHeight,t?void 0:(t=!0,e.log({t:msgTime},function(e){var i;return t=!1,i=e.length,i&&(msgTime=e[0].timestamp,r.scrollTop=r.scrollHeight-n,e.reverse()),_.each(e,function(e){return showMsg(e,!0)}),o.resolve()}),o)},showMsg=function(e,n){var t,r,o;return o="",t=e.fromPeerId,r=e.fromPeerId.split(":")[1],o=e.msg.type?e.msg.text:e.msg,String(o).replace(/^\s+/,"").replace(/\s+$/,"")&&r!==client_id?showLog(formatTime(e.timestamp)+" "+encodeHTML(r)+"： ",o,n):void 0},formatTime=function(e){var n;return n=new Date(e),$.format.date(n,"hh:mm:ss")},main=function(e,n,t){var r;return r=elements.printWall,showLog("正在连接有渔直播聊天系统，请等待。。。"),connect(e,n,t).then(function(e,n){return bindEvent(e,n),showLog("欢迎来到有渔直播间"),n.join(function(){return getLog(n).then(function(){return r.scrollTop(r[0].scrollHeight),"游客"!==t?showLog("已经加入，可以开始聊天。"):void 0})}),n.receive(function(e){return r.scrollTop(r[0].scrollHeight),msgTime||(msgTime=e.timestamp),showMsg(e)}),e.on("reuse",function(){return showLog("正在重新连接有渔直播聊天系统")}),e.on("error",function(){return showLog("好像有什么不对劲 请打开console 查看相关日志 "),console.log(e)}),e.on("join",function(e){return _.each(e.m,function(e){var n;return n=e.split(":")[1],n!==t?showLog(n+"加入有渔直播间"):void 0})}),e.on("left",function(e){return console.log(e)})})},clear_members=function(){return room.list(function(e){return room.remove(e,function(){return console.log("clear_members")})})},get_online_members=function(e,n,t){var r,o;return null==t&&(t={}),r=[],o=new AV.Promise,n.list(function(n){var t,i;return t=function(){i=[];for(var e=0,t=parseInt(n.length/20);t>=0?t>=e:e>=t;t>=0?e++:e--)i.push(e);return i}.apply(this),_.each(t,function(t){var i;return i=n.slice(20*t,20*(t+1)),e.ping(i,function(e){return _.each(e,function(e){return r.push(e)}),o.resolve(r)})})}),timeoutPromise(o,1e4)},get_member=function(e,n){var t;return t=new AV.Promise,get_online_members(e,n).then(function(e){var n,r,o;return r=e.map(function(e){return originClientId(e)}),n=_.clone(members),_.each(r,function(e){var t;return t=clientIdToMember(e),n=_.without(n,t)}),client_id=null!=(o=n[0])?o.clientId:void 0,t.resolve(client_id)}),t},timeoutPromise=function(e,n){var t,r;return t=function(){return new AV.Promise(function(e){return setTimeout(e,n)})},r=t(n).then(function(){return Promise.reject(new Error("请求超时"))}),AV.Promise.race([e,r])},this.chat_demo.get_member=function(){return get_conversation().then(function(e){return connect(roomname,e,"leanCloud").then(function(e,n){return get_member(e,n).then(function(n){return console.log(n),close_connect(e)})})})},this.chat_demo.get_online_members=function(){return get_conversation().then(function(e){return connect(roomname,e,"leanCloud").then(function(e,n){return get_online_members(e,n).then(function(n){return console.log(n),close_connect(e)})})})},this.chat_demo.get_conversation=get_conversation,this.chat_demo.start=start,this.chat_demo.clear_members=clear_members,this.chat_demo.connect=connect;